---
import Layout from '../layouts/Layout.astro';
import LoginHeader from '../components/login/LoginHeader.astro';
import { supabase } from '../lib/supabase';

export const prerender = false;

const accessToken = Astro.cookies.get('sb-access-token');
const refreshToken = Astro.cookies.get('sb-refresh-token');

if (accessToken && refreshToken) {
const { data } = await supabase.auth.setSession({
    access_token: accessToken.value,
    refresh_token: refreshToken.value,
});

if (data.user) {
    return Astro.redirect('/admin/dashboard');
}
}
---
<Layout title="Admin Login">
    <div class="flex min-h-screen items-center justify-center p-4">
        <div class="w-full max-w-md space-y-8">
            <LoginHeader />
            
            <div class="rounded-xl bg-card-light dark:bg-card-dark p-8 shadow-lg">
                <form class="space-y-6" id="login-form">
                    <div>
                        <label class="block text-sm font-medium" for="email">Dirección de Email</label>
                        <div class="mt-1">
                            <input id="email" name="email" type="email" required class="form-input block w-full rounded-lg border-input-light bg-background-light p-3 focus:border-primary focus:ring-primary" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium" for="password">Contraseña</label>
                        <div class="mt-1">
                            <input id="password" name="password" type="password" required class="form-input block w-full rounded-lg border-input-light bg-background-light p-3 focus:border-primary focus:ring-primary" />
                        </div>
                    </div>
                    <div id="error-message" class="text-red-500 text-sm hidden"></div>
                    <div>
                        <button type="submit" class="flex w-full justify-center rounded-lg bg-primary px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-primary/90">
                            Ingresar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { supabase } from '../lib/supabase';

    const loginForm = document.getElementById('login-form');
    const errorMessageDiv = document.getElementById('error-message');

    if (loginForm && errorMessageDiv) {
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault(); 
            errorMessageDiv.classList.add('hidden');
            errorMessageDiv.textContent = '';

            const emailInput = document.getElementById('email') as HTMLInputElement;
            const passwordInput = document.getElementById('password') as HTMLInputElement;

            const { data, error } = await supabase.auth.signInWithPassword({
                email: emailInput.value,
                password: passwordInput.value,
            });

            console.log("Respuesta de Supabase:", { data, error });

            if (error) {
                errorMessageDiv.textContent = 'Email o contraseña incorrectos.';
                errorMessageDiv.classList.remove('hidden');
            } else if (data.user) {
                window.location.href = '/admin/dashboard';
            } else {
                errorMessageDiv.textContent = 'Ocurrió un error inesperado. Intente de nuevo.';
                errorMessageDiv.classList.remove('hidden');
            }
        });
    } else {
        console.error("Error Crítico: No se encontró el elemento #login-form o #error-message en la página.");
    }
</script>